---
title: "PETZOLD"
author: "Valentine Petzold"
format: html
---

https://github.com/valentinepetzold-code/grades-eval

# 1. Introduction
# 1.1 Study organisation
# 1)
```{r}
here::i_am("grades-eval.Rproj")
```
```{r}
library(vroom)
library(ggplot2)
library(dplyr)
library(tidyr)
```
```{r}
courses <- vroom::vroom(
  "courses.csv",
  delim = ",",
  col_types = list(
    course = col_character(),
    course_id = col_integer(),
    trimester = col_integer(),
    nb_grades = col_integer()
  )
)
```

# 2)

```{r}
courses <- courses %>%
  rename(
    
    course_name = course,
    identifier = course_id,
    number_of_exams = nb_grades
  ) %>%
  arrange(course_name)

knitr::kable(courses)
```

#  1.2 Students

# 3)

```{r}
students <- vroom::vroom(
  "students.csv",
  delim = ",",
  col_types = list(
    id = col_integer(),
    group = col_factor(),
    birth_date = col_date(format = "%Y-%m-%d"),
    sex = col_factor()
  )
)

paste(
  "The birth_date column of the students data frame is of class",
  class(students$birth_date)
)

students %>% 
  slice_head(n = 10) %>% 
knitr::kable()
```

# 1.3 Grades

# 4)

```{r}
grades <- vroom::vroom(
  "grades.csv",
  delim = ":",          # séparateur inhabituel
  na = "unknown",       # gérer les valeurs manquantes
  col_types = list(
    id = col_integer(),
    course_id = col_integer(),
    grade = col_double()
  )
)

# Affichage d'un extrait
grades %>% 
  slice_head(n = 10) %>% 
knitr::kable()
```

#  2. Student population analysis


# 5)

```{r}
students %>%
  count(group) %>%
  ggplot(aes(x = group, y = n)) +
  geom_col() +
  labs(x = "Group", y = "Number of students")
```

# 6

```{r}
students |>
  count(group, sex) |>
  ggplot(aes(x = group, y = n, fill = sex)) +
  geom_col()
```

# 7)

```{r}
# Calculer âge en années entières (arrondi à l'entier le plus proche si besoin)
library(lubridate)

students <- students |>
mutate(age = floor(time_length(today() - birth_date, unit = "year")))

students |>
ggplot(aes(x = age)) +
geom_histogram(binwidth = 1, boundary = 0, closed = "left") +
labs(title = "Distribution of student ages", x = "Age (years)", y = "Count")

```
# 8)

```{r}
median_age_by_group <- students |>
  group_by(group) |>
  summarise(median_age = as.integer(median(age, na.rm = TRUE))) |>
  arrange(desc(median_age))

knitr::kable(median_age_by_group)
```

# 9)

```{r}
oldest_by_group <- students |>
  group_by(group) |>
  slice_max(age, with_ties = FALSE) |>
  select(id, group, sex, age) |>
  arrange(desc(age))

knitr::kable(oldest_by_group)
```

#  3. Simple grade analysis

# 10)

```{r}
n_grades <- grades |>
  filter(!is.na(grade)) |>
  nrow()

cat("The data set contains", n_grades, "grades.\n")
```
# 11)

```{r}
library(stringr)

# Identify the relevant courses
target_courses <- courses |>
  filter(str_detect(tolower(course_name), "moral philosophy|ethical decision"))

# Stop if no course found
if (nrow(target_courses) == 0) {
  stop("Couldn't find any courses automatically. Please check courses.csv.")
}

# Get the course IDs
course_ids <- target_courses$course_id

# Compute average grades by group for these courses
avg_grades <- grades |>
  filter(course_id %in% course_ids, !is.na(grade)) |>
  left_join(students |> select(id, group), by = "id") |>
  group_by(group) |>
  summarise(avg_grade = mean(grade, na.rm = TRUE)) |>
  arrange(as.numeric(as.character(group)))

# Plot the averages
avg_grades |>
  ggplot(aes(x = factor(group), y = avg_grade)) +
  geom_col(fill = "skyblue", color = "black") +
  labs(x = "Group", y = "Average grade", title = "Average Grades in Moral Philosophy & Ethical Decision-Making by Group") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```


```{r}
target_courses <- courses |>
  filter(course_name %in% c("Moral Philosophy 101", "Ethics & Decision Making"))

course_ids <- target_courses$identifier

avg_grades <- grades |>
  filter(course_id %in% course_ids, !is.na(grade)) |>
  left_join(students |> select(id, group), by = "id") |>
  group_by(group) |>
  summarise(avg_grade = mean(grade, na.rm = TRUE)) |>
  arrange(as.numeric(as.character(group)))

avg_grades |>
  ggplot(aes(x = factor(group), y = avg_grade)) +
  geom_col(fill = "skyblue", color = "black") +
  labs(x = "Group", y = "Average grade", title = "Average Grades by Group") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

# 12)

```{r}
courses <- courses |>
  rename(course_id = identifier)
```

```{r}
grades_with_trimester <- grades |>
  left_join(courses |> select(course_id, trimester), by = "course_id")
```

```{r}
grades_with_trimester |>
  filter(!is.na(grade)) |>
  mutate(trimester = factor(trimester)) |>
  ggplot(aes(x = trimester, y = grade)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.1, outlier.size = 0.8) +
  labs(title = "Grade Distributions by Trimester", x = "Trimester", y = "Grade")
```

#  4. Attendance analysis

# 13)

```{r}
library(knitr)

grades_per_student <- grades |>
  filter(!is.na(grade)) |>
  group_by(id) |>
  summarise(n_grades = n()) |>
  left_join(students |> select(id, group, sex), by = "id") |>
  arrange(desc(n_grades))

grades_per_student |>
  slice_head(n = 10) |>
  kable()


```

```{r}
stats_table <- tibble(
  min = min(grades_per_student$n_grades, na.rm = TRUE),
  max = max(grades_per_student$n_grades, na.rm = TRUE),
  mean = round(mean(grades_per_student$n_grades, na.rm = TRUE), 2),
  median = median(grades_per_student$n_grades, na.rm = TRUE)
)

kable(stats_table)
```

# 14)

```{r}
grades_per_student |>
  ggplot(aes(x = n_grades, fill = sex)) +
  geom_density(alpha = 0.4) +
  labs(title = "Distribution of Number of Grades per Student by Sex",
       x = "Number of Grades",
       y = "Density")
```

# 15)

```{r}
comm_course <- courses |>
  filter(str_detect(tolower(course_name), "community building|social organization"))

if (nrow(comm_course) == 0) stop("Course 'Community Building and Social Organization' not found automatically.")

comm_id <- comm_course$course_id[1]

comm_counts <- grades |>
  filter(course_id == comm_id, !is.na(grade)) |>
  group_by(id) |>
  summarise(n_comm = n()) |>
  right_join(students |> select(id, group), by = "id") |>
  replace_na(list(n_comm = 0)) |>
  arrange(desc(n_comm))

comm_counts |>
  slice_head(n = 10) |>
  kable()
```

# 16)

```{r}
comm_counts |>
  count(n_comm) |>
  ggplot(aes(x = as.factor(n_comm), y = n)) +
  geom_col(fill = "skyblue", color = "black") +
  labs(
    x = "Number of Grades in Community Building",
    y = "Number of Students",
    title = "Distribution of the Number of Grades in Community Building"
  )
```

# 17)

```{r}
comm_counts |>
  ggplot(aes(x = as.factor(group), y = n_comm)) +
  geom_boxplot(fill = "skyblue", color = "black") +
  stat_summary(fun = median, geom = "point", color = "red", size = 2) +
  labs(
    x = "Group",
    y = "Number of Grades in Community Building",
    title = "Distribution of Community Building Grades by Group"
  )
```

# 18)

```{r}
comm_counts |>
  left_join(students |> select(id, sex), by = "id") |>
  ggplot(aes(x = as.factor(group), y = n_comm, color = sex)) +
  geom_jitter(width = 0.2, alpha = 0.6) +
  stat_summary(
    fun = median,
    geom = "point",
    aes(group = interaction(group, sex)),
    position = position_dodge(width = 0.6),
    size = 2
  ) +
  labs(
    title = "Community Building Grades Count by Group and Sex",
    x = "Group",
    y = "Number of Grades"
  )
```

#  5. Grade analysis

# 19)

```{r}
avg_by_student_course <- grades |>
  filter(!is.na(grade)) |>
  group_by(id, course_id) |>
  summarise(avg_grade = mean(grade, na.rm = TRUE), .groups = "drop")

avg_by_student_course <- avg_by_student_course |>
  left_join(courses |> select(course_id, course_name), by = "course_id")

student_course_wide <- avg_by_student_course |>
  select(id, course_name, avg_grade) |>
  pivot_wider(names_from = course_name, values_from = avg_grade)

student_course_wide <- students |>
  select(id, group) |>
  left_join(student_course_wide, by = "id")

student_course_wide |>
  select(id, group, everything()) |>
  slice_head(n = 6) |>
  kable()
```

# 20)

```{r}
# Identifier les noms de cours

rad_course <- courses %>% filter(str_detect(tolower(course_name), "radiation ecology"))
if(nrow(rad_course) == 0) stop("Radiation Ecology course not found automatically.")
rad_id <- rad_course$course_id[1]

# Community id = comm_id déjà obtenu (comm_id)

# Calculer moyenne par étudiant pour ces deux cours

rad_comm_avgs <- avg_by_student_course %>%
filter(course_id %in% c(rad_id, comm_id)) %>%
pivot_wider(names_from = course_id, values_from = avg_grade, names_prefix = "course_") %>%
rename(
rad_avg = paste0("course_", rad_id),
comm_avg = paste0("course_", comm_id)
) %>%
left_join(students %>% select(id, group), by = c("id"))

rad_comm_avgs %>%
filter(!is.na(rad_avg) & !is.na(comm_avg)) %>%
ggplot(aes(x = comm_avg, y = rad_avg)) +
geom_point() +
geom_smooth(method = "lm", se = FALSE) +
labs(x = "Average Community Building", y = "Average Radiation Ecology", title = "Rad Ecology vs Community Building averages per student")

```

# 21)

```{r}

surv_course <- courses |> filter(str_detect(tolower(course_name), "survival skills|wilderness medicine"))
if(nrow(surv_course) == 0) stop("Survival Skills course not found automatically.")
surv_id <- surv_course$course_id[1]


mp_surv <- avg_by_student_course |>
filter(course_id %in% c(moral_id, surv_id)) |>
pivot_wider(names_from = course_id, values_from = avg_grade, names_prefix = "course_") |>
rename(
moral_avg = paste0("course_", moral_id),
surv_avg = paste0("course_", surv_id)
) |>
left_join(students |> select(id, group), by = "id") |>
group_by(group) |>
summarise(correlation = cor(moral_avg, surv_avg, use = "complete.obs")) |>
arrange(desc(correlation))

kable(mp_surv)

```

# 22)

```{r}
best_group <- mp_surv %>% slice_max(abs(correlation), n = 1) %>% pull(group)

Nuage pour ce groupe

avg_by_student_course %>%
filter(course_id %in% c(moral_id, surv_id)) %>%
pivot_wider(names_from = course_id, values_from = avg_grade) %>%
rename(moral_avg = paste0(moral_id), surv_avg = paste0(surv_id)) %>%
left_join(students %>% select(id, group), by = "id") %>%
filter(group == best_group, !is.na(moral_avg) & !is.na(surv_avg)) %>%
ggplot(aes(x = moral_avg, y = surv_avg)) +
geom_point() +
geom_smooth(method = "lm", se = FALSE) +
labs(title = paste("Moral vs Survival for group", best_group), x = "Moral avg", y = "Survival avg")
```

# 23)

```{r}
# Pour chaque étudiant, moyenne des moyennes des cours

final_grade_df <- avg_by_student_course %>%
group_by(id) %>%
summarise(final_grade = mean(avg_grade, na.rm = TRUE)) %>%
left_join(students %>% select(id, group, sex), by = "id") %>%
arrange(desc(final_grade))

final_grade_df %>% slice_head(n = 5) %>% kable()

```


# 24) 

```{r}
final_grade_df %>%
ggplot(aes(x = as.factor(group), y = final_grade)) +
geom_boxplot() +
labs(title = "Final grade by group", x = "Group", y = "Final grade") +
theme(axis.text.x = element_text(angle=90, vjust=0.5))
```

# 25)

```{r}
final_grade_df %>%
ggplot(aes(x = as.factor(group), y = final_grade, fill = sex)) +
geom_boxplot(position = position_dodge(width = 0.9)) +
labs(title = "Final grade by group and sex", x = "Group", y = "Final grade") +
theme(axis.text.x = element_text(angle=90, vjust=0.5))
```


# 26)

```{r}

student_course_avg <- avg_by_student_course %>%
select(id, course_id, avg_grade) %>%
left_join(courses %>% select(course_id, trimester), by = "course_id")

cond1 <- student_course_avg %>%
group_by(id) %>%
summarise(any_below_5 = any(avg_grade < 5, na.rm = TRUE))

trimester_avg <- student_course_avg %>%
group_by(id, trimester) %>%
summarise(trim_avg = mean(avg_grade, na.rm = TRUE), .groups = "drop")

cond2 <- trimester_avg %>%
group_by(id) %>%
summarise(all_trim_ge_10 = all(trim_avg >= 10, na.rm = TRUE))

pass_df <- final_grade_df %>%
left_join(cond1, by = "id") %>%
left_join(cond2, by = "id") %>%
mutate(
any_below_5 = replace_na(any_below_5, FALSE),
all_trim_ge_10 = replace_na(all_trim_ge_10, FALSE),
pass = (!any_below_5) & (all_trim_ge_10)
) %>%
select(id, group, final_grade, pass)

pass_df %>% slice_head(n = 10) %>% kable()

```

# 27)

```{r}
fail_but_high <- pass_df |>
  filter(pass == FALSE & final_grade >= 10)

n_fail_but_high <- nrow(fail_but_high)
cat("Number of students who do not pass but have final_grade >= 10:", n_fail_but_high, "\n")
```
# 28)

```{r}
library(scales)

pass_rate_by_group <- pass_df |>
  group_by(group) |>
  summarise(pass_rate = mean(pass, na.rm = TRUE), n = n())

pass_rate_by_group |>
  ggplot(aes(x = as.factor(group), y = pass_rate)) +
  geom_col(fill = "skyblue", color = "black") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = "Pass Rate by Group", x = "Group", y = "Pass Rate")
```

# 29)

```{r}
course_fail_counts <- student_course_avg |>
  group_by(course_id) |>
  summarise(n_below_5 = sum(avg_grade < 5, na.rm = TRUE), .groups = "drop") |>
  left_join(courses |> select(course_id, course_name), by = "course_id") |>
  arrange(desc(n_below_5))

kable(course_fail_counts)

most_responsible <- course_fail_counts |>
  slice_max(n_below_5, n = 1)

most_responsible
```

# 30)

```{r}
pass_with_age <- pass_df |>
  left_join(students |> select(id, age), by = "id")

pass_with_age |>
  group_by(age) |>
  summarise(pass_rate = mean(pass, na.rm = TRUE), n = n(), .groups = "drop") |>
  ggplot(aes(x = age, y = pass_rate)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Pass Rate as a Function of Age",
    x = "Age (years)",
    y = "Pass Rate"
  )
```

