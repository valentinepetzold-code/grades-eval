---
title: "PETZOLD"
author: "Valentine Petzold"
format: html
---
# 1.1 Study organisation
# 1)
```{r}
here::i_am("grades-eval.Rproj")
```
```{r}
library(vroom)
library(ggplot2)
library(dplyr)
library(tidyr)
```
```{r}
courses <- vroom::vroom(
  "courses.csv",
  delim = ",",
  col_types = list(
    course = col_character(),
    course_id = col_integer(),
    trimester = col_integer(),
    nb_grades = col_integer()
  )
)
```

# 2)

```{r}
courses <- courses %>%
  rename(
    
    course_name = course,
    identifier = course_id,
    number_of_exams = nb_grades
  ) %>%
  arrange(course_name)

knitr::kable(courses)
```

#  1.2 Students

# 3)

```{r}
students <- vroom::vroom(
  "students.csv",
  delim = ",",
  col_types = list(
    id = col_integer(),
    group = col_factor(),
    birth_date = col_date(format = "%Y-%m-%d"),
    sex = col_factor()
  )
)

paste(
  "The birth_date column of the students data frame is of class",
  class(students$birth_date)
)

students %>% 
  slice_head(n = 10) %>% 
knitr::kable()
```

# 1.3 Grades

# 4)

```{r}
grades <- vroom::vroom(
  "grades.csv",
  delim = ":",          # séparateur inhabituel
  na = "unknown",       # gérer les valeurs manquantes
  col_types = list(
    id = col_integer(),
    course_id = col_integer(),
    grade = col_double()
  )
)

# Affichage d'un extrait
grades %>% 
  slice_head(n = 10) %>% 
knitr::kable()
```

#  2. Student population analysis


# 5)

```{r}
students %>%
  count(group) %>%
  ggplot(aes(x = group, y = n)) +
  geom_col() +
  labs(x = "Group", y = "Number of students")
```

# 6

```{r}
students |>
  count(group, sex) |>
  ggplot(aes(x = group, y = n, fill = sex)) +
  geom_col()
```

# 7)

```{r}
# Calculer âge en années entières (arrondi à l'entier le plus proche si besoin)
library(lubridate)

students <- students |>
mutate(age = floor(time_length(today() - birth_date, unit = "year")))

students |>
ggplot(aes(x = age)) +
geom_histogram(binwidth = 1, boundary = 0, closed = "left") +
labs(title = "Distribution of student ages", x = "Age (years)", y = "Count")

```
# 8)

```{r}
median_age_by_group <- students |>
  group_by(group) |>
  summarise(median_age = as.integer(median(age, na.rm = TRUE))) |>
  arrange(desc(median_age))

knitr::kable(median_age_by_group)
```

# 9)

```{r}
oldest_by_group <- students |>
  group_by(group) |>
  slice_max(age, with_ties = FALSE) |>
  select(id, group, sex, age) |>
  arrange(desc(age))

knitr::kable(oldest_by_group)
```

#  3. Simple grade analysis

# 10)

```{r}
n_grades <- grades |>
  filter(!is.na(grade)) |>
  nrow()

cat("The data set contains", n_grades, "grades.\n")
```
# 11)

```{r}
library(stringr)

# Identify the relevant courses
target_courses <- courses |>
  filter(str_detect(tolower(course_name), "moral philosophy|ethical decision"))

# Stop if no course found
if (nrow(target_courses) == 0) {
  stop("Couldn't find any courses automatically. Please check courses.csv.")
}

# Get the course IDs
course_ids <- target_courses$course_id

# Compute average grades by group for these courses
avg_grades <- grades |>
  filter(course_id %in% course_ids, !is.na(grade)) |>
  left_join(students |> select(id, group), by = "id") |>
  group_by(group) |>
  summarise(avg_grade = mean(grade, na.rm = TRUE)) |>
  arrange(as.numeric(as.character(group)))

# Plot the averages
avg_grades |>
  ggplot(aes(x = factor(group), y = avg_grade)) +
  geom_col(fill = "skyblue", color = "black") +
  labs(x = "Group", y = "Average grade", title = "Average Grades in Moral Philosophy & Ethical Decision-Making by Group") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```


```{r}
target_courses <- courses |>
  filter(course_name %in% c("Moral Philosophy 101", "Ethics & Decision Making"))

course_ids <- target_courses$identifier

avg_grades <- grades |>
  filter(course_id %in% course_ids, !is.na(grade)) |>
  left_join(students |> select(id, group), by = "id") |>
  group_by(group) |>
  summarise(avg_grade = mean(grade, na.rm = TRUE)) |>
  arrange(as.numeric(as.character(group)))

avg_grades |>
  ggplot(aes(x = factor(group), y = avg_grade)) +
  geom_col(fill = "skyblue", color = "black") +
  labs(x = "Group", y = "Average grade", title = "Average Grades by Group") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

# 12)

```{r}
courses <- courses |>
  rename(course_id = identifier)
```

```{r}
grades_with_trimester <- grades |>
  left_join(courses |> select(course_id, trimester), by = "course_id")
```

```{r}
grades_with_trimester |>
  filter(!is.na(grade)) |>
  mutate(trimester = factor(trimester)) |>
  ggplot(aes(x = trimester, y = grade)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.1, outlier.size = 0.8) +
  labs(title = "Grade Distributions by Trimester", x = "Trimester", y = "Grade")
```

